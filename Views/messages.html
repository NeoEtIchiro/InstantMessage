<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Instant Message</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Conteneur principal pour conversations et messages -->
    <div class="flex flex-grow">
        <!-- Liste des conversations à gauche -->
        <aside class="w-1/4 border-r overflow-auto">
            <h2 class="text-xl font-bold p-4 border-b">Conversations</h2>
            <ul id="conversation-list">
                <!-- La liste sera chargée dynamiquement -->
                <li class="p-4 text-center text-gray-500">Chargement…</li>
            </ul>
        </aside>

        <!-- Zone de messages pour la conversation sélectionnée -->
        <section class="flex-grow p-4">
            <div id="messages-container">
                <h2 class="text-2xl font-bold mb-4">Bienvenue sur la messagerie</h2>
                <p>Sélectionnez une conversation sur la gauche ou recherchez un utilisateur.</p>
            </div>
        </section>
    </div>

    <!-- Footer en bas de la page -->
    <footer class="w-full p-4 bg-gray-800 text-white">
        <nav>
            <ul class="flex justify-center gap-16">
                <li><a href="messages.html" class="hover:underline">Messages</a></li>
                <li><a href="search.html" class="hover:underline">Rechercher</a></li>
                <li><a href="account.html" class="hover:underline">Compte</a></li>
            </ul>
        </nav>
    </footer>

    <script>
        $(document).ready(function() {

            // Fonction de chargement d'une conversation donnée
            function loadConversation(conversationId) {
                $.ajax({
                    url: "../api/message.php?action=getMessages",
                    method: "GET",
                    data: { id: conversationId },
                    dataType: "html",
                    success: function(data) {
                        $("#messages-container").html(data);
                    },
                    error: function() {
                        $("#messages-container").html("<p>Erreur lors du chargement des messages.</p>");
                    }
                });
            }

            // Fonction pour charger la liste des conversations de l'utilisateur
            function loadConversations() {
                $.ajax({
                    url: "../api/conversation.php?action=getConversations",
                    method: "GET",
                    dataType: "json",
                    success: function(response) {
                        $("#conversation-list").empty();
                        if(response.conversations && response.conversations.length > 0) {
                            response.conversations.forEach(function(conv) {
                                var li = $('<li>', {
                                    text: conv.other_login,
                                    'data-id': conv.conversation_id,  // l'identifiant de la conversation
                                    class: "p-4 border-b cursor-pointer hover:bg-gray-100"
                                });
                                $("#conversation-list").append(li);
                            });
                        } else {
                            $("#conversation-list").append("<li class='p-4 text-center text-gray-500'>Aucune conversation trouvée.</li>");
                        }
                    },
                    error: function() {
                        $("#conversation-list").html("<li class='p-4 text-center text-gray-500'>Erreur lors du chargement des conversations.</li>");
                    }
                });
            }

            // Gestion du clic sur une conversation de la liste
            $("#conversation-list").on('click', 'li[data-id]', function() {
                var conversationId = $(this).data('id');
                loadConversation(conversationId);
            });

            // Si un paramètre userId est présent dans l'URL,
            // essayer d'obtenir ou créer la conversation directe correspondante
            let params = new URLSearchParams(window.location.search);
            if (params.has('userId')) {
                let userId = params.get('userId');
                $.ajax({
                    url: "../api/conversation.php?action=getOrCreateConversation",
                    method: "GET",
                    data: { userId: userId },
                    dataType: "json",
                    success: function(response) {
                        if (response.conversationId) {
                            loadConversation(response.conversationId);
                        } else {
                            $("#messages-container").html("<p>Erreur lors de la création de la conversation.</p>");
                        }
                    },
                    error: function() {
                        $("#messages-container").html("<p>Erreur lors de la création de la conversation.</p>");
                    }
                });
            }

            // Chargement initial de la liste des conversations
            loadConversations();
        });
    </script>
</body>
</html>